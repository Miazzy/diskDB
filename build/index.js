"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DiskDB = void 0;
const global_1 = require("./global");
const helper_1 = require("./helper");
const async_1 = require("async");
const nanoid_1 = require("nanoid");
const path_1 = require("path");
class DiskDB {
    constructor(options) {
        this.store = new Map();
        options.path = options.path || __dirname;
        if (options.collections.length === 0) {
            helper_1.ERR.log(global_1.MESSAGES.ERROR.COLL_MT);
            throw new Error(global_1.MESSAGES.ERROR.COLL_MT);
        }
        this.options = options;
    }
    addDocumentToCollection(collectionName, doc) {
        const coll = this.findOneCollection(collectionName);
        if (!coll) {
            helper_1.ERR.log(global_1.MESSAGES.ERROR.COLL_NF + collectionName);
            return false;
        }
        try {
            const data = coll.documents;
            if (Array.isArray(doc)) {
                doc.forEach((d) => {
                    const dbDoc = {
                        _id: nanoid_1.nanoid(),
                        data: d,
                        meta: helper_1.getMeta(),
                    };
                    data.push(dbDoc);
                });
            }
            else {
                data.push({
                    _id: nanoid_1.nanoid(),
                    data: doc,
                    meta: helper_1.getMeta(),
                });
            }
            coll.documents = data;
            return true;
        }
        catch (error) {
            throw new Error(error);
        }
    }
    findCollections() {
        return this.store;
    }
    findDocumentFromCollectionByID(collectionName, docId) {
        const coll = this.findOneCollection(collectionName);
        let doc = {};
        if (!coll) {
            helper_1.ERR.log(global_1.MESSAGES.ERROR.COLL_NF + collectionName);
            return false;
        }
        const docs = coll.documents;
        if (docs.length === 0) {
            return doc;
        }
        docs.forEach((docm) => {
            if (docm._id === docId) {
                doc = docm;
                return;
            }
        });
        return doc;
    }
    findDocumentsFromCollectionByQuery(collectionName, docId) {
        const coll = this.findOneCollection(collectionName);
        let doc = {};
        if (!coll) {
            helper_1.ERR.log(global_1.MESSAGES.ERROR.COLL_NF + collectionName);
            return false;
        }
        const docs = coll.documents;
        if (docs.length === 0) {
            return doc;
        }
        docs.forEach((docm) => {
            if (docm._id === docId) {
                doc = docm;
                return;
            }
        });
        return doc;
    }
    findOneCollection(collectionName) {
        return this.store.get(collectionName);
    }
    loadCollections() {
        return new Promise((resolve, reject) => {
            async_1.each(this.options.collections, (collectionName, callback) => __awaiter(this, void 0, void 0, function* () {
                helper_1.LOG.log(global_1.MESSAGES.INFO.PRCG + collectionName);
                if (!collectionName.includes(global_1.EXT_JSON)) {
                    collectionName = `${collectionName}${global_1.EXT_JSON}`;
                }
                const collectionFile = path_1.join(this.options.path, collectionName);
                const fsExists = yield helper_1.fileExists(collectionFile);
                let fileContents = JSON.parse(global_1.EMPTY_ARRAY);
                if (!fsExists) {
                    yield helper_1.writeToCollection(collectionFile, JSON.stringify(fileContents));
                }
                else {
                    fileContents =
                        (yield helper_1.readFromCollection(collectionFile)) || fileContents;
                }
                const coll = {
                    documents: fileContents ? fileContents : [],
                    name: collectionName.replace(global_1.EXT_JSON, ''),
                    path: collectionFile,
                };
                this.store.set(coll.name, coll);
                callback();
            }), err => {
                if (err) {
                    helper_1.ERR.log(global_1.MESSAGES.ERROR.LOAD_FL + err.message);
                    reject(global_1.MESSAGES.ERROR.LOAD_FL);
                    throw new Error(global_1.MESSAGES.ERROR.LOAD_FL + err.message);
                }
                else {
                    helper_1.LOG.log(global_1.MESSAGES.INFO.COLL_LD_DONE);
                    resolve(this.store);
                }
            });
        });
    }
    removeCollection(collectionName) {
        return this.store.delete(collectionName);
    }
    removeDocumentFromCollection(collectionName, docId) {
        const coll = this.findOneCollection(collectionName);
        if (!coll) {
            helper_1.ERR.log(global_1.MESSAGES.ERROR.COLL_NF + collectionName);
            return false;
        }
        try {
            coll.documents = coll.documents.filter((d) => d._id !== docId);
            return true;
        }
        catch (error) {
            throw new Error(error);
        }
    }
}
exports.DiskDB = DiskDB;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUEscUNBQTJEO0FBQzNELHFDQU9rQjtBQUdsQixpQ0FBNkI7QUFDN0IsbUNBQWdDO0FBQ2hDLCtCQUE0QjtBQUs1QixNQUFhLE1BQU07SUFJakIsWUFBWSxPQUFtQjtRQUZ4QixVQUFLLEdBQWlCLElBQUksR0FBRyxFQUFrQixDQUFDO1FBR3JELE9BQU8sQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksSUFBSSxTQUFTLENBQUM7UUFFekMsSUFBSSxPQUFPLENBQUMsV0FBVyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDcEMsWUFBRyxDQUFDLEdBQUcsQ0FBQyxpQkFBUSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNoQyxNQUFNLElBQUksS0FBSyxDQUFDLGlCQUFRLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ3pDO1FBQ0QsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7SUFDekIsQ0FBQztJQUVNLHVCQUF1QixDQUFDLGNBQXNCLEVBQUUsR0FBUTtRQUM3RCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsY0FBYyxDQUFDLENBQUM7UUFFcEQsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNULFlBQUcsQ0FBQyxHQUFHLENBQUMsaUJBQVEsQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLGNBQWMsQ0FBQyxDQUFDO1lBQ2pELE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFFRCxJQUFJO1lBQ0YsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQWtCLENBQUM7WUFFckMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO2dCQUV0QixHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUU7b0JBRXJCLE1BQU0s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LHdCQTBMQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVNUFRZX0FSUkFZLCBFWFRfSlNPTiwgTUVTU0FHRVMgfSBmcm9tICcuL2dsb2JhbCc7XG5pbXBvcnQge1xuICBFUlIsXG4gIGZpbGVFeGlzdHMsXG4gIGdldE1ldGEsXG4gIExPRyxcbiAgcmVhZEZyb21Db2xsZWN0aW9uLFxuICB3cml0ZVRvQ29sbGVjdGlvbixcbn0gZnJvbSAnLi9oZWxwZXInO1xuaW1wb3J0IHsgSUNvbGxlY3Rpb24sIElEQk9wdGlvbnMsIElEb2N1bWVudCwgVENvbGxlY3Rpb25zIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcblxuaW1wb3J0IHsgZWFjaCB9IGZyb20gJ2FzeW5jJztcbmltcG9ydCB7IG5hbm9pZCB9IGZyb20gJ25hbm9pZCc7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCc7XG5cbi8vIENvbGxlY3Rpb24gPT0gRmlsZS5qc29uXG4vLyBEb2N1bWVudCA9PSBGaWxlLk9ialswXS5qc29uXG5cbmV4cG9ydCBjbGFzcyBEaXNrREIge1xuICBwdWJsaWMgb3B0aW9uczogSURCT3B0aW9ucztcbiAgcHVibGljIHN0b3JlOiBUQ29sbGVjdGlvbnMgPSBuZXcgTWFwKCkgYXMgVENvbGxlY3Rpb25zO1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IElEQk9wdGlvbnMpIHtcbiAgICBvcHRpb25zLnBhdGggPSBvcHRpb25zLnBhdGggfHwgX19kaXJuYW1lO1xuXG4gICAgaWYgKG9wdGlvbnMuY29sbGVjdGlvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICBFUlIubG9nKE1FU1NBR0VTLkVSUk9SLkNPTExfTVQpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKE1FU1NBR0VTLkVSUk9SLkNPTExfTVQpO1xuICAgIH1cbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICB9XG5cbiAgcHVibGljIGFkZERvY3VtZW50VG9Db2xsZWN0aW9uKGNvbGxlY3Rpb25OYW1lOiBzdHJpbmcsIGRvYzogYW55KTogYm9vbGVhbiB7XG4gICAgY29uc3QgY29sbCA9IHRoaXMuZmluZE9uZUNvbGxlY3Rpb24oY29sbGVjdGlvbk5hbWUpO1xuXG4gICAgaWYgKCFjb2xsKSB7XG4gICAgICBFUlIubG9nKE1FU1NBR0VTLkVSUk9SLkNPTExfTkYgKyBjb2xsZWN0aW9uTmFtZSk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRhdGEgPSBjb2xsLmRvY3VtZW50cyBhcyBhbnlbXTtcbiAgICAgIC8vIGJ1bGsgYWRkXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShkb2MpKSB7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tc2hhZG93ZWQtdmFyaWFibGVcbiAgICAgICAgZG9jLmZvckVhY2goKGQ6IGFueSkgPT4ge1xuICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tc2hhZG93ZWQtdmFyaWFibGVcbiAgICAgICAgICBjb25zdCBkYkRvYzogSURvY3VtZW50ID0ge1xuICAgICAgICAgICAgX2lkOiBuYW5vaWQoKSxcbiAgICAgICAgICAgIGRhdGE6IGQsXG4gICAgICAgICAgICBtZXRhOiBnZXRNZXRhKCksXG4gICAgICAgICAgfTtcbiAgICAgICAgICBkYXRhLnB1c2goZGJEb2MpO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHNpbmdsZSBkb2N1bWVudCBhZGRcbiAgICAgICAgZGF0YS5wdXNoKHtcbiAgICAgICAgICBfaWQ6IG5hbm9pZCgpLFxuICAgICAgICAgIGRhdGE6IGRvYyxcbiAgICAgICAgICBtZXRhOiBnZXRNZXRhKCksXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb2xsLmRvY3VtZW50cyA9IGRhdGE7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZmluZENvbGxlY3Rpb25zKCk6IFRDb2xsZWN0aW9ucyB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmU7XG4gIH1cblxuICBwdWJsaWMgZmluZERvY3VtZW50RnJvbUNvbGxlY3Rpb25CeUlEKFxuICAgIGNvbGxlY3Rpb25OYW1lOiBzdHJpbmcsXG4gICAgZG9jSWQ6IHN0cmluZ1xuICApOiBJRG9jdW1lbnQgfCBudWxsIHwgZmFsc2Uge1xuICAgIGNvbnN0IGNvbGwgPSB0aGlzLmZpbmRPbmVDb2xsZWN0aW9uKGNvbGxlY3Rpb25OYW1lKTtcbiAgICBsZXQgZG9jOiBJRG9jdW1lbnQgfCBhbnkgPSB7fTtcblxuICAgIGlmICghY29sbCkge1xuICAgICAgRVJSLmxvZyhNRVNTQUdFUy5FUlJPUi5DT0xMX05GICsgY29sbGVjdGlvbk5hbWUpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGNvbnN0IGRvY3MgPSBjb2xsLmRvY3VtZW50cztcblxuICAgIGlmIChkb2NzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIGRvYztcbiAgICB9XG5cbiAgICBkb2NzLmZvckVhY2goKGRvY206IElEb2N1bWVudCkgPT4ge1xuICAgICAgaWYgKGRvY20uX2lkID09PSBkb2NJZCkge1xuICAgICAgICBkb2MgPSBkb2NtO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gZG9jO1xuICB9XG5cbiAgcHVibGljIGZpbmREb2N1bWVudHNGcm9tQ29sbGVjdGlvbkJ5UXVlcnkoXG4gICAgY29sbGVjdGlvbk5hbWU6IHN0cmluZyxcbiAgICBkb2NJZDogc3RyaW5nXG4gICk6IElEb2N1bWVudCB8IG51bGwgfCBmYWxzZSB7XG4gICAgY29uc3QgY29sbCA9IHRoaXMuZmluZE9uZUNvbGxlY3Rpb24oY29sbGVjdGlvbk5hbWUpO1xuICAgIGxldCBkb2M6IElEb2N1bWVudCB8IGFueSA9IHt9O1xuXG4gICAgaWYgKCFjb2xsKSB7XG4gICAgICBFUlIubG9nKE1FU1NBR0VTLkVSUk9SLkNPTExfTkYgKyBjb2xsZWN0aW9uTmFtZSk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgY29uc3QgZG9jcyA9IGNvbGwuZG9jdW1lbnRzO1xuXG4gICAgaWYgKGRvY3MubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gZG9jO1xuICAgIH1cblxuICAgIGRvY3MuZm9yRWFjaCgoZG9jbTogSURvY3VtZW50KSA9PiB7XG4gICAgICBpZiAoZG9jbS5faWQgPT09IGRvY0lkKSB7XG4gICAgICAgIGRvYyA9IGRvY207XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBkb2M7XG4gIH1cblxuICBwdWJsaWMgZmluZE9uZUNvbGxlY3Rpb24oY29sbGVjdGlvbk5hbWU6IHN0cmluZyk6IElDb2xsZWN0aW9uIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZS5nZXQoY29sbGVjdGlvbk5hbWUpO1xuICB9XG5cbiAgcHVibGljIGxvYWRDb2xsZWN0aW9ucygpOiBQcm9taXNlPFRDb2xsZWN0aW9ucyB8IHN0cmluZz4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBlYWNoKFxuICAgICAgICB0aGlzLm9wdGlvbnMuY29sbGVjdGlvbnMsXG4gICAgICAgIGFzeW5jIChjb2xsZWN0aW9uTmFtZTogc3RyaW5nLCBjYWxsYmFjaykgPT4ge1xuICAgICAgICAgIExPRy5sb2coTUVTU0FHRVMuSU5GTy5QUkNHICsgY29sbGVjdGlvbk5hbWUpO1xuXG4gICAgICAgICAgaWYgKCFjb2xsZWN0aW9uTmFtZS5pbmNsdWRlcyhFWFRfSlNPTikpIHtcbiAgICAgICAgICAgIGNvbGxlY3Rpb25OYW1lID0gYCR7Y29sbGVjdGlvbk5hbWV9JHtFWFRfSlNPTn1gO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IGNvbGxlY3Rpb25GaWxlID0gam9pbih0aGlzLm9wdGlvbnMucGF0aCwgY29sbGVjdGlvbk5hbWUpO1xuICAgICAgICAgIGNvbnN0IGZzRXhpc3RzOiBib29sZWFuID0gYXdhaXQgZmlsZUV4aXN0cyhjb2xsZWN0aW9uRmlsZSk7XG4gICAgICAgICAgbGV0IGZpbGVDb250ZW50czogSUNvbGxlY3Rpb25bJ2RvY3VtZW50cyddID0gSlNPTi5wYXJzZShFTVBUWV9BUlJBWSk7XG4gICAgICAgICAgaWYgKCFmc0V4aXN0cykge1xuICAgICAgICAgICAgYXdhaXQgd3JpdGVUb0NvbGxlY3Rpb24oXG4gICAgICAgICAgICAgIGNvbGxlY3Rpb25GaWxlLFxuICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeShmaWxlQ29udGVudHMpXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBmaWxlQ29udGVudHMgPVxuICAgICAgICAgICAgICAoYXdhaXQgcmVhZEZyb21Db2xsZWN0aW9uKGNvbGxlY3Rpb25GaWxlKSkgfHwgZmlsZUNvbnRlbnRzO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IGNvbGw6IElDb2xsZWN0aW9uID0ge1xuICAgICAgICAgICAgZG9jdW1lbnRzOiBmaWxlQ29udGVudHMgPyBmaWxlQ29udGVudHMgOiBbXSxcbiAgICAgICAgICAgIG5hbWU6IGNvbGxlY3Rpb25OYW1lLnJlcGxhY2UoRVhUX0pTT04sICcnKSxcbiAgICAgICAgICAgIHBhdGg6IGNvbGxlY3Rpb25GaWxlLFxuICAgICAgICAgIH07XG5cbiAgICAgICAgICB0aGlzLnN0b3JlLnNldChjb2xsLm5hbWUsIGNvbGwpO1xuXG4gICAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgfSxcbiAgICAgICAgZXJyID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBFUlIubG9nKE1FU1NBR0VTLkVSUk9SLkxPQURfRkwgKyBlcnIubWVzc2FnZSk7XG4gICAgICAgICAgICByZWplY3QoTUVTU0FHRVMuRVJST1IuTE9BRF9GTCk7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoTUVTU0FHRVMuRVJST1IuTE9BRF9GTCArIGVyci5tZXNzYWdlKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgTE9HLmxvZyhNRVNTQUdFUy5JTkZPLkNPTExfTERfRE9ORSk7XG4gICAgICAgICAgICByZXNvbHZlKHRoaXMuc3RvcmUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyByZW1vdmVDb2xsZWN0aW9uKGNvbGxlY3Rpb25OYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZS5kZWxldGUoY29sbGVjdGlvbk5hbWUpO1xuICB9XG5cbiAgcHVibGljIHJlbW92ZURvY3VtZW50RnJvbUNvbGxlY3Rpb24oXG4gICAgY29sbGVjdGlvbk5hbWU6IHN0cmluZyxcbiAgICBkb2NJZDogc3RyaW5nXG4gICk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGNvbGwgPSB0aGlzLmZpbmRPbmVDb2xsZWN0aW9uKGNvbGxlY3Rpb25OYW1lKTtcblxuICAgIGlmICghY29sbCkge1xuICAgICAgRVJSLmxvZyhNRVNTQUdFUy5FUlJPUi5DT0xMX05GICsgY29sbGVjdGlvbk5hbWUpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb2xsLmRvY3VtZW50cyA9IGNvbGwuZG9jdW1lbnRzLmZpbHRlcigoZDogSURvY3VtZW50KSA9PiBkLl9pZCAhPT0gZG9jSWQpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvcik7XG4gICAgfVxuICB9XG59XG4iXX0=